<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Libra/Violas 交易币种 TypeTag 生成器</title>
    <link href="https://cdn.jsdelivr.net/gh/Dreamer-Paul/Kico-Style/kico.min.css" rel="stylesheet" type="text/css"/>
    <link href="static/doc.css" rel="stylesheet" type="text/css"/>
    <meta name="viewport" content="width=device-width, maximum-scale=1, initial-scale=1"/>
</head>
<body>

<main class="content">
    <div class="header">
        <h1>Libra/Violas 交易币种 TypeTag 生成器</h1>
        <h2>用于生成并验证币种信息</h2>
    </div>

    <article class="post">
        <div>
            <a class="float-right btn green small" href="index.html">返回首页</a>
        </div>
        <section>
            <h2 id>生成发起兑换交易脚本</h2>
            <fieldset>
                <label>
                    <span>Version</span>
                    <input id="start_version" type="text"
                           value="0x0003" placeholder="脚本版本"/>
                </label>
                <label>
                    <span>Type</span>
                    <input id="start_type" type="text"
                           value="0x3000" placeholder="脚本类型"/>
                </label>

                <label>
                    <span>Payee Address</span>
                    <input id="start_payee_address" type="text"
                           value="c91806cabcd5b2b5fa25ae1c50bed3c6" placeholder="收款地址"/>
                </label>

                <label>
                    <span>sequence</span>
                    <input id="start_sequence" type="text"
                           value="20200110006" placeholder="时间戳"/>
                </label>

                <label>
                    <span>sequence</span>
                    <input id="start_module_address" type="text"
                           value="524689a4f870c46d6a5d901b5ac1fdb2" placeholder="合约地址"/>
                </label>

                <label>
                    <span>sequence</span>
                    <input id="start_out_amount" type="number"
                           value="10000" placeholder="最小输出金额 单位为最小单位"/>
                </label>

                <label>
                    <span>times</span>
                    <input id="start_times" type="number"
                           value="0" placeholder="重试次数"/>
                </label>

                <button class="btn green" id="btn_start_script_generate">生成 TypeTag 信息</button>

            </fieldset>
            <label>
                <span>生成发起兑换交易脚本</span>
                <pre class=" language-html"><code id="start_script_output"
                                                  class=" language-html">请点击生成 TypeTag 信息</code></pre>
            </label>
        </section>
    </article>
</main>

<footer>
    <a class="to-top" href="#"></a>
    <p>© 2020 By <a href="https://violas.io/" target="_blank">Violas Team</a>.</p>
</footer>
</body>
<script src="https://cdn.jsdelivr.net/gh/Dreamer-Paul/Kico-Style/kico.min.js"></script>
<script src="static/tiddlybit.min.js"></script>
<script type="text/javascript">
    const {Script, OpCode} = TiddlyBit

    const toHexString = bytes =>
        bytes.reduce((str, byte) => str + byte.toString(16).padStart(2, '0'), '');

    const fromHexString = hexString =>
        new Uint8Array(hexString.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));

    const stringToBytes = (str) => {
        let ch, st, re = [];
        for (let i = 0; i < str.length; i++) {
            ch = str.charCodeAt(i);  // get char
            st = [];                 // set up "stack"

            do {
                st.push(ch & 0xFF);  // push byte to stack
                ch = ch >> 8;          // shift value down by 1 byte
            }

            while (ch);
            re = re.concat(st.reverse());
        }
        return re;
    }

    const checkParam = (object, msg) => {
        if (!object) {
            ks.notice(msg, {
                time: 3000,
                color: "red"
            });
            throw "check error";
        }
    }
    const getInt64BigEndianBytes = (x) => {
        let bytes = [];
        bytes[0] = (x >> 56) & 255
        bytes[1] = (x >> 48) & 255
        bytes[2] = (x >> 40) & 255
        bytes[3] = (x >> 32) & 255
        bytes[4] = (x >> 24) & 255
        bytes[5] = (x >> 16) & 255
        bytes[6] = (x >> 8) & 255
        bytes[7] = x & 255
        return bytes;
    }

    const getInt16BigEndianBytes = (x) => {
        let bytes = [];
        bytes[0] = (x >> 8) & 255
        bytes[1] = x & 255
        return bytes;
    }

    const getInt64Bytes = (x) => {
        let bytes = [];
        let i = 8;
        do {
            bytes[--i] = x & (255);
            x = x >> 8;
        } while (i)
        return bytes;
    }

    const getInt16Bytes = (x) => {
        let bytes = [];
        let i = 2;
        do {
            bytes[--i] = x & (255);
            x = x >> 8;
        } while (i)
        return bytes;
    }

    document.getElementById("btn_start_script_generate").onclick = function () {
        const startVersion = document.getElementById("start_version").value;
        const startType = document.getElementById("start_type").value;
        const startPayeeAddress = document.getElementById("start_payee_address").value;
        const startSequence = document.getElementById("start_sequence").value;
        const startModuleAddress = document.getElementById("start_module_address").value;
        const startOutAmount = document.getElementById("start_out_amount").value;
        const startTimes = document.getElementById("start_times").value;

        try {
            checkParam(startVersion, "请填写脚本版本")
            checkParam(startType, "请填写脚本类型")
            checkParam(startPayeeAddress, "请填写收款地址")
            checkParam(startSequence, "请填写脚本时间戳")
            checkParam(startModuleAddress, "请填写合约地址")
            checkParam(startOutAmount, "请填写最小输出金额")
            checkParam(startTimes, "请填写脚本重试次数")
        } catch (e) {
            return null
        }

        const script = new Script([
            'violas',
            // fromHexString(startVersion.replace("0x", "")),
            // fromHexString(startType.replace("0x", "")),
            // fromHexString(startPayeeAddress),
            // getInt64BigEndianBytes(startSequence),
            // fromHexString(startModuleAddress),
            // getInt64BigEndianBytes(startOutAmount),
            // getInt16BigEndianBytes(startTimes)
        ])

        document.getElementById("start_script_output").innerHTML = script.toHex();
    };
</script>
</html>
